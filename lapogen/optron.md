# Optron_tester

Firmware project for an STM32-based magnetic/current test device. This repository contains the application source generated by STM32CubeIDE (HAL + LL mix) and supporting code. The main firmware runs on an STM32F3-series MCU and provides: 

- DAC waveform generation (sine) with DMA triggered by TIM7
- ADC measurements (including VREFINT-based Vdd calculation)
- I2C interface to AS5600 magnetic rotary sensor
- USART2 console for control and telemetry
- Encoder input on TIM3 (configured as encoder interface)
- Persistent storage of a zero-angle offset using the `ee` module

This README documents wiring, build and usage notes derived from `Core/Src/main.c`.

## Files of interest

- `Core/Src/main.c` — main application. Contains the app logic, serial command parser and peripheral initialization.
- `Core/Inc/ee.h`, `Core/Src/ee.c` — EEPROM/flash storage helpers (used to persist zero-angle). (See `ee_init`, `ee_read`, `ee_write` usage in `main.c`.)
- `Core/Inc/main.h`, `Core/Src/*` — MCU peripheral init code generated by CubeIDE.

## Purpose

The firmware controls a current-source-like output using the DAC1 peripheral and a DMA-fed waveform buffer. It reads measurements (ADC channels and AS5600 angle), exposes commands over USART2, and stores a zero-angle offset in flash.

Typical use-cases:

- Generate sinusoidal current waveforms (or DC) to drive an external transducer.
- Read back LED voltage and a "peek" measurement via ADC.
- Read angular position via AS5600 and optionally zero the angle reference.
- Interact with the device over a serial terminal for test automation.

## Hardware / Wiring (from code)

Important connections inferred from `main.c`:

- DAC outputs:
  - PA4 -> DAC1_OUT1 (waveform output, DMA-driven)
  - PA5 -> DAC1_OUT2 (used as a simple DAC channel in code)

- ADC inputs:
  - ADC channel 1 is labeled in code as VLED (likely connected to LED measurement)
  - ADC channel 2 is labeled as VPEEK
  - ADC internal VREFINT channel used to compute Vdd

- I2C (AS5600):
  - I2C1 on PB6 (SCL) and PB7 (SDA) in alternate open-drain mode (code also configures PA6/PA5 as inputs during init — see `MX_I2C1_Init`).
  - AS5600 7-bit address used as 0x36 (shifted left for HAL: `(0x36)<<1`).

- USART2 (PC console):
  - PA2 = USART2_TX
  - PA15 = USART2_RX (VCP_RX_Pin is used)
  - Baud rate: 115200, 8N1

- Encoder input:
  - TIM3 configured as encoder with filtered inputs (TI1/TI2), hardware pins depend on board layout.

Note: Confirm your board schematic/pinout before wiring. The code assumes specific pins generated by CubeMX/STM32CubeIDE.

## Build (STM32CubeIDE)

1. Open the project in STM32CubeIDE: open the folder `Optron_tester` or the workspace that contains it.
2. Make sure your toolchain and target board (STM32F3xx) are installed and configured in STM32CubeIDE.
3. Build the project (Project -> Build All). The project uses HAL/LL drivers generated by CubeMX.
4. Flash using the debugger or a programmer (ST-Link): Run -> Debug or Run -> Debug As -> STM32 Cortex-M C/C++ Application.

Alternatively you can build from the command-line if you have the proper Makefiles / toolchain configured (the `Debug/` folder contains a makefile generated by the IDE).

## Serial protocol (USART2)

The firmware exposes a simple text-based command interface on USART2 (115200 baud). Commands are ASCII lines terminated by CR or LF. Responses are ASCII lines.

Supported commands (as implemented in `message_handler()` in `main.c`):

- measure_all
  - Description: Measure all sensors and report values
  - Returns: `freq=xxxx, amp=xxxx, offset=xxxx, voltled=xxxx, peek=xxxx, angle=xxxx` followed by CRLF

- set_sin amp=<uA>, offset=<uA>, freq=<Hz>
  - Description: Configure the sine wave/ DAC output. Values are in microamperes (uA) for amp and offset; freq is in Hz.
  - Notes: The code maps uA into the 12-bit DAC range using MAX_CURRENT = 30000 (uA). For DC output set amp=0 and a nonzero offset. Maximum practical frequency depends on the DMA/TIM configuration and sample count.
  - Returns: `ok!` on success or an error message when the frequency is invalid.

- set_zero_angle
  - Description: Read the AS5600 angle and store the current reading as the zero-angle offset in flash (calls `ee_write`).
  - Returns: `ok! zero angle set to <degrees>` or `error!` if the AS5600 read fails.
  - Warning: Writes to flash are finite; avoid calling this frequently.

- get_firmware_info
  - Description: Returns build timestamp and magnet sensor status (calls `magnetNOK()`)
  - Returns: `info! build: <TIMESTAMP>    magnet_status:_ <n>`

Any unknown command replies with a Czech-language default: `Neco se pokazilo` (something went wrong).

Example session (from a terminal):

> measure_all
< freq=1000, amp=10000, offset=15000, voltled=1234, peek=2345, angle=12

> set_sin amp=5000, offset=10000, freq=1000
< ok!

> set_zero_angle
< ok! zero angle set to 123 degrees

## ADC & Vdd calibration

The firmware calculates Vdd using the internal VREFINT channel and a reference constant `VREF_VOLTAGE = 1200` (mV). The helper `ADC_mV()` averages AVERAGEING (100) samples.

## AS5600 Magnetic sensor notes

- The code reads AS5600 status to determine magnet strength via `magnetNOK()`.
- `readAngle()` returns an angle value (in degrees) by reading the AS5600 angle register and converting from 0..4095 to 0..360 degrees. The code uses `readAndZeroAngle()` to return an angle offset by the stored zero-angle.

## EEPROM/Flash zero-angle storage

The `ee` module is used to persist a single struct with a `zeroAngle` float. On startup the project calls `ee_init(&ee_data, sizeof(stotrage_t)); ee_read();`.

## Troubleshooting

- If AS5600 reads fail, double-check I2C wiring (PB6=SCL, PB7=SDA) and pull-ups.
- If DAC waveform is noisy, confirm the DAC output buffering and hardware filtering. The code disables the buffer for channel 1: `LL_DAC_SetOutputBuffer(DAC1, LL_DAC_CHANNEL_1, LL_DAC_OUTPUT_BUFFER_DISABLE);`
- If ADC readings are incorrect, verify VREFINT calibration and the `VREF_VOLTAGE` constant.

## Notes and next steps

- Confirm physical pin assignments in CubeMX-generated files (look in `Core/Inc` and `Core/Src`) before wiring.
- Consider adding safer parsing and bounds checking for serial commands.
- Consider adding a help command and better English localization for returned messages.
